### 단일 서버 환경에서 서버의 성능을 어떻게 개선할 수 있을까?
성능 테스트를 해서 병목 지점을 찾고 병목 지점의 원인을 분석한 후 개선해야합니다.
### 성능 개선을 할 때 단계별로 어떻게 진행해야할까?
1. 현재 시스템이 처리할 수 있는 동시 사용자 수 및 TPS를 파악(모니터링 도구를 통해서 확인)
2. 얼마만큼의 동시 사용자 수 및 TPS를 늘릴 것인지 목표 설정 
3. 어느 지점에서 병목이 발생하는 파악하기 
4. 병목 지점 파악 후 개선
5. 이 후 목표 TPS가 달성될 때까지 성능 테스트를 반복하면서 병목 개선

### 트래픽 증가로 인한 병목 현상이 발생했을 때 어떻게 병목 지점을 찾을 수 있을까?
일차적으로 WAS에서 스레드 풀이 최대치에 근접하거나 요청이 스레드를 얻기 위해 대기하면서 오래 지연된다면 WAS 자체의 병목을 의심할 수 있습니다. 하지만 스레드 풀이 최대치에 도달했다고 해서 반드시 WAS 자체의 문제라고 단정 지을 수는 없습니다.

WAS는 요청 처리의 중심 역할을 담당하며, 요청의 진입점으로서 다음과 같은 외부 시스템과 연계됩니다:
- WAS → DB
- WAS → 외부 시스템 및 API
  
이러한 외부 시스템(DB 또는 API)의 처리 속도가 느려지거나 응답이 지연될 경우 WAS의 스레드는 외부 응답을 기다리며 오랜 시간 동안 점유 상태로 유지됩니다. 결과적으로 새로운 요청들이 스레드를 얻지 못하고 대기 상태로 쌓이면서 WAS의 스레드 풀이 고갈되는 현상이 나타날 수 있습니다. 따라서 스레드 풀이 고갈되는 현상은 반드시 WAS 자체의 병목을 의미하는 것이 아니라, 외부 시스템(DB 또는 API)의 응답 지연이 근본적인 원인일 수 있습니다.
그러나 DB나 외부 API 호출이 느리다고 해서 반드시 스레드 풀이 고갈되는 것은 아닙니다. 실제로 스레드 풀이 고갈되는 상황은 처리 속도에 비해 들어오는 요청의 수가 많을 때만 발생합니다. 반대로 요청이 적다면, 비록 DB나 API 응답이 느리더라도 스레드 풀의 여유가 계속 유지될 수 있으며, 스레드 풀 고갈 현상은 발생하지 않습니다.
결론적으로, WAS 스레드 풀의 고갈 현상은 처리 속도에 비해 높은 트래픽이 발생할 때인데, 그 원인은 트래픽 대비 스레드 풀의 크기가 작은 것이 원인일 수도 있고 DB 또는 외부 API의 응답 속도가 느린 것일 수도 있습니다.

그렇기 때문에 스레드 풀이 최대치가 된다면 이 후 확인해볼 것은 DB를 의심해볼 수 있을 것 같습니다. DB의 커넥션 풀이 최대치에 이르렀는지 확인해볼 수 있을 것 같습니다.
만약 DB의 커넥션 풀이 최대치에 이르렀다면 DB 병목으로 인한 지연으로 확정할 수 있을 것 같습니다.

#### WAS - DB 관점에서 상황
#### 1. DB 응답시간은 빠르나 DB 커넥션 풀도 여유로운 상황  (병목 x)
정상적인 상황
#### 2. DB 응답시간은 느리나 DB 커넥션 풀은 여유로운 상황 - 정상적인 상황 (병목 x)
DB 응답시간이 느리면 DB로 인한 병목이 생길 수 있을 것 같으나 커넥션 풀이 여유롭기 때문에 다른 커넥션을 통해서 DB 요청이 가능 그리고 일반적으로 스레드 풀이 커넥션 풀보다 크기 때문에 DB 응답시간이 느리다고해서 DB로 인해 스레드 풀이 먼저 고갈되는 현상은 발생되기 어렵습니다. (외부시스템 지연 등 복합적으로는 가능)
#### 3. DB 응답시간은 빠르나 DB 커넥션 풀이 최대치에 이른 상황 (병목 o)
DB 커넥션 풀의 크기가 작은 것이므로 크기를 키우면됩니다. 

**이 경우에는 실무적인 환경에서는 확인하기 어려울 것 같다. 예를 들어 일반적으로 DB커넥션 풀이 꽉 차면 DB 응답시간이 길어지게된다.  DB 응답시간은 DB 커넥션 획득 대기시간 + 실제 쿼리 처리 시간이므로 DB 커넥션 풀이 꽉차게된다면 DB 응답시간도 길어짐.  그러기 때문에 실무에서는 DB 커넥션 풀이 꽉차게 되었을 때 쿼리의 문제인지 커넥션 풀의 크기가 작아서 생기는 문제인지 파악하기 어려울 것 같다.**
#### 4. DB 응답시간도 느리고 DB 커넥션 풀도 최대치에 이른 상황 (병목 o)
DB 응답시간이 느리고 DB 커넥션 풀이 최대치에 도달한 상황에서는 DB 관련 성능 개선 작업을 반드시 수행해야 합니다. 운영 환경에서 병목 현상을 단기적으로 빠르게 처리해야 한다면 일차적으로 DB 커넥션 풀의 크기를 늘리는 방법을 사용할 수 있지만, 이는 근본적인 해결책은 아니므로 장기적으로는 다음과 같은 방법으로 성능을 개선해야 합니다.
1. DB 쿼리 튜닝
2. 자주 호출되는 느린 쿼리에 대한 캐시 적용    
    - 반복적이고 변경이 적은 데이터를 캐시하여 DB 접근 횟수 최소화    
    - 분산 환경에서는 Redis 같은 외부 캐시 서버를 통해 데이터 동기화
    - 단일 서버 환경에서는 로컬 캐시를 사용해서 성능 개선
    - 어플리케이션 레벨의 캐시(Redis, 로컬 캐시)는 DRAM 기반의 메인 메모리를 말한다. (CPU 내부의 SRAM 기반의 초고속 캐시와 다른 개념)
3. DB 커넥션 Timeout 설정
    - DB 커넥션 획득을 위한 최대 대기 시간을 제한하여 장시간 기다리는 요청으로 인해 WAS 스레드 풀이 고갈되는 현상을 방지    
4. DB 서버의 Scale-Up 또는 Scale-Out
    - CPU, 메모리 증설과 같은 하드웨어 성능 개선       
    - DB 복제(Replication), 샤딩(Sharding) 등 분산 처리 전략 적용
